name: Rclone Entware IPK (armv7-3.2)

on:
  workflow_dispatch:
  push:
    tags:
      - "*"

permissions:
  contents: write

jobs:
  build_entware_ipk:
    name: build-ipk-armv7-3.2
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: ">=1.23.0"
          check-latest: true

      - name: Install packaging dependencies
        shell: bash
        run: |
          set -euo pipefail
          sudo apt-get update
          sudo apt-get install -y perl tar gzip xz-utils curl

      - name: Fetch opkg-build script (no git clone)
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p /tmp/opkg-utils
          curl -fsSL -o /tmp/opkg-utils/opkg-build \
            https://raw.githubusercontent.com/openwrt/opkg-utils/master/opkg-build
          chmod +x /tmp/opkg-utils/opkg-build
          /tmp/opkg-utils/opkg-build --help >/dev/null 2>&1 || true

      - name: Build rclone (linux/armv7)
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p build

          if [[ "${GITHUB_REF}" == refs/tags/* ]]; then
            VER="${GITHUB_REF_NAME}"
          else
            VER="0.0.0-git${GITHUB_SHA:0:7}"
          fi
          echo "VER=${VER}" >> "$GITHUB_ENV"

          export GOOS=linux
          export GOARCH=arm
          export GOARM=7
          export CGO_ENABLED=0

          go build -v -trimpath \
            -ldflags "-s -w -X github.com/rclone/rclone/fs.Version=${VER}" \
            -o build/rclone .

          chmod +x build/rclone

      - name: Package as Entware IPK (armv7-3.2)
        shell: bash
        run: |
          set -euo pipefail

          PKG="rclone"
          ARCH="armv7-3.2"
          SOURCE_URL="https://github.com/${GITHUB_REPOSITORY}"

          PKGDIR="$(mktemp -d)"
          mkdir -p "${PKGDIR}/CONTROL" "${PKGDIR}/opt/bin"

          install -m 0755 build/rclone "${PKGDIR}/opt/bin/rclone"
          INSTALLED_SIZE_KB="$(du -sk "${PKGDIR}/opt" | awk '{print $1}')"

          printf '%s\n' \
            "Package: ${PKG}" \
            "Version: ${VER}" \
            "Architecture: ${ARCH}" \
            "Maintainer: doomwithdon" \
            "Section: utils" \
            "Priority: optional" \
            "Source: ${SOURCE_URL}" \
            "Installed-Size: ${INSTALLED_SIZE_KB}" \
            "Description: rclone - rsync for cloud storage" \
            " Rclone syncs files to and from cloud storage providers." \
            > "${PKGDIR}/CONTROL/control"

          printf '%s\n' \
            "#!/bin/sh" \
            "set -e" \
            "exit 0" \
            > "${PKGDIR}/CONTROL/postinst"
          chmod 0755 "${PKGDIR}/CONTROL/postinst"

          echo "PKGDIR=${PKGDIR}"
          find "${PKGDIR}" -maxdepth 3 -print

          # root ownership avoids UID warnings
          sudo chown -R 0:0 "${PKGDIR}"

          mkdir -p build
          /tmp/opkg-utils/opkg-build "${PKGDIR}" build

          echo "Built IPKs:"
          ls -lah build/*.ipk

      - name: Upload IPK Artifact
        uses: actions/upload-artifact@v4
        with:
          name: rclone-entware-ipk-armv7-3.2
          path: build/*.ipk
          retention-days: 7

  release:
    name: Release (tags only)
    runs-on: ubuntu-latest
    needs: build_entware_ipk
    timeout-minutes: 15

    steps:
      - name: Download IPK Artifact
        uses: actions/download-artifact@v4
        with:
          name: rclone-entware-ipk-armv7-3.2
          path: build

      - name: Create/Update GitHub Release and upload .ipk
        if: startsWith(github.ref, 'refs/tags/')
        env:
          GH_TOKEN: ${{ github.token }}
        shell: bash
        run: |
          set -euo pipefail
          TAG="${{ github.ref_name }}"
          FILE="$(ls -1 build/*.ipk | head -n 1)"

          if gh release view "${TAG}" >/dev/null 2>&1; then
            gh release upload "${TAG}" "${FILE}" --clobber
          else
            gh release create "${TAG}" \
              --title "rclone ${TAG} (Entware IPK armv7-3.2)" \
              --notes "Entware installable .ipk for ASUS Merlin (armv7-3.2)." \
              "${FILE}"
          fi
