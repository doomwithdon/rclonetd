name: Rclone Build (Entware IPK armv7sf-k3.2)

on:
  workflow_dispatch:
  push:
    tags:
      - "*"

permissions:
  contents: write

jobs:
  build_entware_ipk:
    name: entware-ipk-armv7sf-k3.2
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install Go
        uses: actions/setup-go@v5
        with:
          go-version: ">=1.23.0"
          check-latest: true

      - name: Print Go version
        shell: bash
        run: |
          which go
          go version
          go env

      - name: Build rclone + generate Entware .ipk (armv7sf-k3.2)
        shell: bash
        run: |
          set -euo pipefail

          mkdir -p build

          # Build static rclone binary for Entware (ARMv7)
          export GOOS=linux
          export GOARCH=arm
          export GOARM=7
          export CGO_ENABLED=0

          BIN_OUT="build/rclone"
          go build -v -trimpath \
            -ldflags "-s -w -X github.com/rclone/rclone/fs.Version=${{ github.ref_name }}" \
            -o "${BIN_OUT}" .

          chmod +x "${BIN_OUT}"

          # ---------------------------
          # Package into an Entware .ipk
          # ---------------------------
          PKG="rclone"
          VER="${{ github.ref_name }}"
          ARCH="armv7sf-k3.2"   # per your request

          PKGROOT="$(mktemp -d)"
          mkdir -p "${PKGROOT}/CONTROL"
          mkdir -p "${PKGROOT}/opt/bin"

          # Install path for Entware
          install -m 0755 "${BIN_OUT}" "${PKGROOT}/opt/bin/rclone"

          # Installed size in KB
          INSTALLED_SIZE_KB="$(du -sk "${PKGROOT}/opt" | awk '{print $1}')"

          # Control metadata
          cat > "${PKGROOT}/CONTROL/control" <<EOF
          Package: ${PKG}
          Version: ${VER}
          Architecture: ${ARCH}
          Maintainer: doomwithdon
          Section: utils
          Priority: optional
          Installed-Size: ${INSTALLED_SIZE_KB}
          Description: rclone - rsync for cloud storage
           Rclone syncs files to and from cloud storage providers.
          EOF

          # Minimal postinst (optional)
          cat > "${PKGROOT}/CONTROL/postinst" <<'EOF'
          #!/bin/sh
          set -e
          if [ -x /opt/bin/rclone ]; then
            /opt/bin/rclone version >/dev/null 2>&1 || true
          fi
          exit 0
          EOF
          chmod 0755 "${PKGROOT}/CONTROL/postinst"

          # debian-binary required by .ipk format
          echo "2.0" > "${PKGROOT}/debian-binary"

          # control.tar.gz must contain control files at archive root
          ( cd "${PKGROOT}/CONTROL" && tar -czf "${PKGROOT}/control.tar.gz" . )

          # data.tar.gz must contain opt/... at archive root
          ( cd "${PKGROOT}" && tar -czf "${PKGROOT}/data.tar.gz" opt )

          OUT_IPK="build/${PKG}_${VER}_${ARCH}.ipk"

          # .ipk is an ar archive of the three parts
          ar r "${OUT_IPK}" \
            "${PKGROOT}/debian-binary" \
            "${PKGROOT}/control.tar.gz" \
            "${PKGROOT}/data.tar.gz"

          echo "Built:"
          ls -lah build/
          file "${OUT_IPK}" || true

      - name: Upload IPK Artifact
        uses: actions/upload-artifact@v4
        with:
          name: rclone-entware-ipk-armv7sf-k3.2
          path: build/*.ipk
          retention-days: 7

  release:
    name: Create Release (attach IPK)
    runs-on: ubuntu-latest
    needs: [build_entware_ipk]
    timeout-minutes: 15

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Ensure tags are available
        shell: bash
        run: |
          git fetch --force --tags
          git describe --tags --always || true

      - name: Download IPK Artifact
        uses: actions/download-artifact@v4
        with:
          name: rclone-entware-ipk-armv7sf-k3.2
          path: build

      - name: Create GitHub Release and upload .ipk
        env:
          GH_TOKEN: ${{ github.token }}
        shell: bash
        run: |
          set -euo pipefail
          TAG="${{ github.ref_name }}"
          FILE="$(ls -1 build/*.ipk | head -n 1)"

          # Create release if it doesn't exist, otherwise just upload asset(s)
          if gh release view "${TAG}" >/dev/null 2>&1; then
            echo "Release ${TAG} already exists. Uploading asset..."
            gh release upload "${TAG}" "${FILE}" --clobber
          else
            echo "Creating release ${TAG}..."
            gh release create "${TAG}" \
              --title "rclone ${TAG} (Entware IPK armv7sf-k3.2)" \
              --notes "Entware installable .ipk for ASUS Merlin (armv7sf-k3.2)." \
              "${FILE}"
          fi
