name: Rclone Build (Entware IPK armv7sf-k3.2)

on:
  workflow_dispatch:
  push:
    tags:
      - "*"

permissions:
  contents: write

jobs:
  build_entware_ipk:
    name: entware-ipk-armv7sf-k3.2
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: ">=1.23.0"
          check-latest: true

      - name: Build rclone and package .ipk
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p build

          export GOOS=linux
          export GOARCH=arm
          export GOARM=7
          export CGO_ENABLED=0

          go build -v -trimpath \
            -ldflags "-s -w -X github.com/rclone/rclone/fs.Version=${{ github.ref_name }}" \
            -o build/rclone .

          chmod +x build/rclone

          PKG="rclone"
          VER="${{ github.ref_name }}"
          ARCH="armv7sf-k3.2"
          OUT_IPK="build/${PKG}_${VER}_${ARCH}.ipk"

          PKGROOT="$(mktemp -d)"
          mkdir -p "${PKGROOT}/CONTROL" "${PKGROOT}/opt/bin"
          install -m 0755 build/rclone "${PKGROOT}/opt/bin/rclone"

          INSTALLED_SIZE_KB="$(du -sk "${PKGROOT}/opt" | awk '{print $1}')"

          printf '%s\n' \
            "Package: ${PKG}" \
            "Version: ${VER}" \
            "Architecture: ${ARCH}" \
            "Maintainer: doomwithdon" \
            "Section: utils" \
            "Priority: optional" \
            "Installed-Size: ${INSTALLED_SIZE_KB}" \
            "Description: rclone - rsync for cloud storage" \
            " Rclone syncs files to and from cloud storage providers." \
            > "${PKGROOT}/CONTROL/control"

          printf '%s\n' \
            "#!/bin/sh" \
            "set -e" \
            "exit 0" \
            > "${PKGROOT}/CONTROL/postinst"
          chmod 0755 "${PKGROOT}/CONTROL/postinst"

          STAGE="$(mktemp -d)"
          printf '%s' "2.0" > "${STAGE}/debian-binary"
          ( cd "${PKGROOT}/CONTROL" && tar -czf "${STAGE}/control.tar.gz" . )
          ( cd "${PKGROOT}" && tar -czf "${STAGE}/data.tar.gz" opt )

          rm -f "${OUT_IPK}"
          ( cd "${STAGE}" && ar r "${GITHUB_WORKSPACE}/${OUT_IPK}" debian-binary control.tar.gz data.tar.gz )

          echo "Built:"
          ls -lah build/
          echo "IPK members:"
          ar t "${OUT_IPK}"

      - name: Upload IPK Artifact
        uses: actions/upload-artifact@v4
        with:
          name: rclone-entware-ipk-armv7sf-k3.2.ipk
          path: build/*.ipk
          retention-days: 7

  release:
    name: Create Release
    runs-on: ubuntu-latest
    needs: [build, android]
    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Ensure tags are available
        shell: bash
        run: |
          git fetch --force --tags
          git describe --tags --always || true

      - name: Download All Artifacts
        uses: actions/download-artifact@v4
        with:
          path: /tmp/build
          pattern: rclone-*
          merge-multiple: true

      - name: Copy Artifacts
        run: |
          mkdir build
          cp -r /tmp/build/* build/

      - name: Upload Assets
        shell: bash
        env:
          GH_TOKEN: ${{ github.token }}
          GITHUB_REPOSITORY: ${{ github.repository }}
          REPO: ${{ github.repository }}
          GH_REPO: ${{ github.repository }}
        run: |
          make upload_github
